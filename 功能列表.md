# 串口工具程序功能清单

## 应用基础信息
- 项目名称：Test Tool
- 类型：Windows Forms 串口通信工具（.NET 8 / C# 12）
- 主要用途：通过串口控制电源设备（ON/OFF），可查看收发日志

---

## 核心功能

### 1. 串口通信管理
- 连接/断开：异步非阻塞；`ConnectAsync`/`DisconnectAsync` 支持取消令牌；Polly 重试（可热更新）
- 连接配置：波特率 115200、数据位 8、Parity=None、StopBits=1、编码 UTF-8，支持超时设置；从 `appsettings.json` 默认值 + 用户配置合并
- 状态通知：`ConnectionStateChanged` 事件驱动 UI，状态标签颜色同步
- 数据收发：`DataReceived`/`DataSent` 事件；`SerialMonitorForm` 彩色展示发送/接收内容（追加时间）
- 错误处理：连接/发送失败进入 Error 状态并记录日志，按钮自动恢复

### 2. 设备控制
- ON/OFF 命令：封装于 `PowerDeviceController`，通过串口服务发送；成功后更新电源状态
- 状态跟踪：`DeviceStatus` 维护连接状态、电源状态、消息时间戳；`StatusChanged` 事件驱动按钮高亮
- 按钮联动：未连接禁用；已连接默认浅蓝；ON 亮绿色、OFF 深红色

### 3. 配置管理
- 持久化文件（`Config` 目录）：
  - `serialport.config`：上次使用的串口
  - `portlock.config`：端口锁定状态
  - `devicename.config`：设备名称（默认 “FCC1电源”）
- 设置窗口：
  - **单行布局**：串口选择、波特率、锁定按钮、打印开关横向排列。
  - **即时保存**：切换锁定状态或点击确定时，立即校验并保存配置。
  - **无模式窗口**：打开设置时主窗口仍可操作（拖动/缩放）。
- 默认参数与策略：`appsettings.json` 定义默认值 + `RetryPolicy`（ConnectRetries/SendRetries/BaseDelayMs）。

### 4. 用户界面
- 主窗口：状态标签 `{设备名} - 状态: {文本}`；连接/ON/OFF 按钮；菜单打开设置与监视器
- 状态色：已连接=绿色，未连接=深灰，警告/连接中=橙色，错误=红色；文字为白色
- 窗口特性：10px 自定义边框拖动，最小尺寸、居中启动，字体缓存（粗体/常规）并在关闭时释放

### 5. 性能与可靠性
- 异步编程避免阻塞 UI；`SemaphoreSlim` 序列化连接/断开
- Polly 重试（指数退避）+ `IOptionsMonitor` 热更新策略（防抖 1s）
- 资源管理：串口适配器、字体、配置监视令牌均在关闭时安全释放

---

## 状态转换
- 连接：Disconnected → (Connect) Connecting → Connected → (Disconnect) Disconnected
- 失败：Connecting → (Failure) Error → (Retry) Connecting
- 电源：Unknown → (ON) On → (OFF) Off → (Disconnect) Unknown

---

## 配置文件说明
- `serialport.config`：文本，内容为串口名（如 `COM3`）
- `portlock.config`：文本，`true`/`false`
- `devicename.config`：文本，自定义设备名（默认 “FCC1电源”）
- `appsettings.json`：运行时默认值 + 重试策略，支持热更新

---

## 扩展与注册
- 支持通过工厂注入多协议/多设备：
  - 协议：实现 `IProtocolParserFactory`/`IProtocolParser`，在 DI 注册替换默认解析器。
  - 设备：实现 `IDeviceControllerFactory`/`IDeviceController`，在 DI 注册以支持不同命令集。
  - 适配器：实现 `ISerialPortAdapterFactory`/`ISerialPortAdapter`，可接入虚拟或自定义串口。

## 测试约定
- 核心服务/协调器使用接口与工厂便于注入 mock。
- 推荐的单测覆盖：
  - `MainFormCoordinator`：连接/断开/保存配置的事件转发。
  - `SerialPortService`：重试策略、连接/发送的异常路径（用假适配器）。
  - `PowerDeviceController`：帧解析驱动电源状态变更。
- 基准：`BenchmarkSuite1` 允许替换适配器为模拟实现，避免真实串口依赖。

---

**最后更新**：2025 年
