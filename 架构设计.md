# 串口工具程序架构文档（更新版）

## 当前功能概览
- 串口连接/断开：异步非阻塞，Polly 重试，支持取消与防抖重建策略。
- 设备控制：ON/OFF 命令、状态跟踪；支持并发一键开/关（可配置并发度与校验）。
- 数据收发：事件驱动；`SerialMonitorForm`/Host 彩色显示发送/接收日志，支持多 Host、拖拽合并/弹出。
- 配置管理：`Config` 目录持久化（串口/锁定/设备名/打印合并/位置等），`appsettings.json` 提供默认值与重试策略热更新。
- UI 体验：状态色标签、按钮态、10px 自定义边框拖动、字体缓存与释放；主窗体底部一键操作区；打印窗多 Host 前后置修复。

---

## 已识别的架构关注点
1. 单一职责：`MainForm` 仍承担部分协调逻辑，已通过 Presenter/Coordinator 分拆但可继续收敛。
2. 重用与抽象：UI 状态切换与颜色常量集中到 `UIConstants`/`UIHelper`，需保持一致性。
3. 可测试性：核心通过接口（如 `ISerialPortAdapter`、`IProtocolParser`、Presenter 接口）隔离，单测已覆盖重试/事件/配置，仍需补充分支场景。
4. 扩展性：协议/适配器/控制器均有工厂接口，可按需替换；多 Host 映射已持久化，兼容旧配置。

---

## 项目结构（当前代码）
```
Test Tool/
├── TestTool.Core/                 # 核心层（枚举、模型、接口）
│   ├── Enums/DeviceEnums.cs
│   ├── Models/DeviceModels.cs     # ConnectionConfig/AppConfig/RetryPolicy 等
│   └── Services/*.cs              # ISerialPortService/IDeviceController 等接口
├── TestTool.Business/             # 业务实现层
│   └── Services/
│       ├── SerialPortService.cs       # 串口服务（重试、通道、热更新）
│       ├── PowerDeviceController.cs   # 电源控制器
│       ├── DefaultSerialPortAdapter.cs# 串口适配器
│       ├── Factories.cs               # 适配器/协议/控制器工厂
│       ├── SimpleProtocolParser.cs    # 协议解析
│       ├── MainFormCoordinator.cs     # 主窗体协调器
│       └── MultiDeviceCoordinator.cs  # 多设备协调器（并发一键开/关）
├── TestTool.Infrastructure/       # 基础设施
│   ├── Constants/AppConstants.cs
│   ├── Constants/UIConstants.cs
│   ├── Constants/UIFormConstants.cs
│   └── Helpers/UIHelper.cs        # UI 跨线程安全、颜色/布局辅助
├── Data/ConfigRepository.cs       # 配置仓储（JSON 持久化，含打印 Host/位置等）
├── Forms/                         # UI 层（WinForms）
│   ├── Base/ResizableFormBase.cs  # 可调整大小基类
│   ├── MainForm*.cs               # 主窗体（多 Host 管理、一键开关/打印）
│   ├── MultiDeviceSettingsForm*.cs# 多设备设置窗体（MVP）
│   ├── SerialMonitorForm*.cs      # 单设备监视窗体
│   └── SerialMonitorHostForm*.cs  # 打印 Host（Tab 合并/弹出、多 Host）
├── TestTool.UI/                   # UI Shell 项目（WinForms）
├── TestTool.Tests/                # 单元测试
│   ├── SerialPortServiceTests.cs
│   ├── MultiDeviceSettingsPresenterTests.cs
│   └── FileConfigRepositoryTests.cs
├── BenchmarkSuite1/               # 基准测试（SerialPortService 发送）
├── Program.cs                     # HostBuilder + DI + 日志
├── appsettings.json               # 默认值、重试策略、并发度等
└── Config/                        # 运行时用户配置（串口/锁定/设备名/打印 Host/位置）
```

---

## 关键组件
### ISerialPortService / SerialPortService
- 事件：`ConnectionStateChanged`、`DataReceived`、`DataSent`
- 方法：`ConnectAsync(ConnectionConfig, CancellationToken)`、`DisconnectAsync(CancellationToken)`、`SendCommandAsync(string, CancellationToken)`
- 状态：`IsConnected`、`CurrentConfig`、`CurrentState`
- 要点：`ISerialPortAdapter` 抽象串口；`SemaphoreSlim` 序列化连接/断开；`Channel<string>` 缓冲接收；Polly 重试（连接/发送）；`IOptionsMonitor` 热更新重试策略（防抖）；异常回滚、Channel 完成、适配器幂等释放。

### IDeviceController / PowerDeviceController
- 事件：`StatusChanged`（封装 `DeviceStatus` 与旧状态）
- 方法：`InitializeAsync`、`TurnOnAsync`、`TurnOffAsync`
- 职责：包装 ON/OFF 命令，维护设备状态并驱动 UI/并发一键开关。

### MultiDeviceCoordinator / MainFormCoordinator
- 多设备并发一键开/关：可配置并发度、超时与结果汇总，校验锁定/连接状态。
- 多 Host 管理：维护设备-Host 映射，拖拽合并/弹出事件处理，兼容旧布尔标记与新 HostId 映射。

### IConfigRepository / FileConfigRepository
- API：`LoadAsync`、`SaveAsync`、`GetValueAsync<T>`、`SetValueAsync<T>`
- 内容：串口配置、端口锁定、设备名、打印窗口合并状态、Host/窗体位置与尺寸、并发度等。
- 策略：缓存优先，文件持久化；缺失使用 `appsettings.json` 默认值；写失败记录日志。

### 协议/适配器/工厂
- `ISerialPortAdapterFactory` / `DefaultSerialPortAdapterFactory`
- `IProtocolParserFactory` / `DefaultProtocolParserFactory`
- `IDeviceControllerFactory`（默认单例 `PowerDeviceController`）
- 便于替换底层串口实现与协议解析；测试可注入模拟实现。

---

## 数据流
```
用户操作 → MainForm / Presenters → MultiDeviceCoordinator → SerialPortService → ISerialPortAdapter → 硬件
                                      ↑事件↑
        SerialPortService.ConnectionStateChanged / DataReceived / DataSent → UI 与监视器（多 Host）
```

---

## UI 状态机
```
连接：Disconnected → (Connect) Connecting → Connected → (Disconnect) Disconnected
失败：Connecting → (Failure) Error → (Retry) Connecting
电源：Unknown → (ON) On → (OFF) Off → (Disconnect) Unknown
打印：独立窗口 ↔ 拖入 Host(Tab) ↔ 弹出；多 Host 映射可切换
```
状态色：已连接=绿色，未连接=深灰，警告/连接中=橙色，错误=红色。

---

## 配置与重试策略
- 运行时配置：`Config/serialport.config`、`portlock.config`、`devicename.config`、打印 Host/窗口位置与合并映射。
- 默认值：`appsettings.json` → `IOptions<AppConfig>`，含重试策略、并发度、串口默认参数。
- 重试：Polly 指数退避；`IOptionsMonitor.OnChange` 防抖热更新策略并计数告警；支持取消。
- 并发：`AppConfig.PowerConcurrency` 控制一键开/关并发度，仓储读写并恢复。

---

## 依赖注入与生命周期
- 单例：`SerialPortService`、`PowerDeviceController`、`FileConfigRepository`、`MainForm`、协调器/工厂。
- 瞬态：`SettingsForm`、`SerialMonitorForm`、`SerialMonitorHostForm`、`ISerialPortAdapter`（默认 `DefaultSerialPortAdapter`）。
- HostBuilder 管理日志/配置绑定并负责释放单例，线程安全释放适配器与事件解绑。

---

## 测试与基准
- 单元测试：`TestTool.Tests` 覆盖串口服务重试与异常、Presenter 交互、配置仓储持久化等。
- 基准测试：`BenchmarkSuite1` 关注 `SendCommandAsync` 性能。

---

**最后更新**：2026-01-10
