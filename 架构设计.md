# 串口工具程序架构文档

## 当前功能概览
- 串口连接/断开：异步非阻塞，支持取消与重试（Polly 策略）
- 设备控制：ON/OFF 命令、状态跟踪、按钮联动
- 数据收发：事件驱动；`SerialMonitorForm` 彩色显示发送/接收日志
- 配置管理：`Config` 目录持久化（串口/锁定/设备名），`appsettings.json` 作为默认值与重试策略热更新
- UI 体验：状态色标签、按钮态、10px 自定义边框拖动、字体缓存与正确释放

---

## 现有架构问题
1. 单一职责不足：`MainForm` 仍承担 UI、串口状态协调与部分配置逻辑。
2. 代码重复：状态设置与配置读写存在重复实现，部分 UI 状态切换可再抽象。
3. 硬编码：命令、颜色、默认串口参数分散在多处（已集中到常量但需保持一致性）。
4. 可测试性：业务与 UI 仍有耦合，需通过接口/适配器隔离交互（目前已有 `ISerialPortAdapter`）。
5. 扩展性：新增设备/协议需修改多处，策略/工厂可进一步抽象（现有接口已预留）。

---

## 项目结构（当前代码）
```
Test Tool/
├── Forms/                 # WinForms 表示层
│   ├── MainForm.*         # 主窗体，事件订阅、UI 联动
│   ├── SettingsForm.*     # 串口选择/锁定、监视器开关
│   └── SerialMonitorForm.*# 串口收发日志窗口
├── Business/              # 业务层
│   ├── Enums/DeviceEnums.cs
│   ├── Models/DeviceModels.cs      # ConnectionConfig/AppConfig/RetryPolicy 等
│   └── Services/
│       ├── IDeviceServices.cs      # ISerialPortService/IDeviceController 及事件
│       ├── ISerialPortAdapter.cs / DefaultSerialPortAdapter.cs
│       ├── IProtocolParser.cs / SimpleProtocolParser.cs
│       ├── SerialPortService.cs
│       └── PowerDeviceController.cs
├── Data/                   # 数据访问
│   └── ConfigRepository.cs
├── Infrastructure/         # 基础设施
│   ├── Constants/AppConstants.cs
│   ├── Constants/UIConstants.cs
│   └── Helpers/UIHelper.cs
├── Test Tool.Tests / WinFormsApp3.Tests # 单元测试
├── BenchmarkSuite1/        # 基准（SendCommandAsync）
├── Program.cs              # HostBuilder + DI + 日志
├── appsettings.json        # 默认值 & 重试策略（热更新）
└── Config/                 # 运行时用户配置文件
```

---

## 关键组件

### ISerialPortService / SerialPortService
- 事件：`ConnectionStateChanged`、`DataReceived`、`DataSent`
- 方法：`ConnectAsync(ConnectionConfig, CancellationToken)`、`DisconnectAsync(CancellationToken)`、`SendCommandAsync(string, CancellationToken)`
- 状态：`IsConnected`、`CurrentConfig`、`CurrentState`
- 实现要点：`ISerialPortAdapter` 抽象底层串口；`SemaphoreSlim` 序列化连接/断开；`Channel<string>` 缓冲接收；Polly 重试（连接/发送）参数来自 `AppConfig.RetryPolicy`，`IOptionsMonitor.OnChange` 热更新并防抖；`Dispose`/`SafeDisposeAdapter` 确保线程安全释放。

### IDeviceController / PowerDeviceController
- 事件：`StatusChanged`（封装 `DeviceStatus` 与旧电源状态）
- 方法：`InitializeAsync(ISerialPortService)`、`TurnOnAsync`、`TurnOffAsync`
- 职责：包装 ON/OFF 命令，维护设备状态并驱动 UI 按钮高亮。

### IConfigRepository / FileConfigRepository
- API：`LoadAsync`、`SaveAsync`、`GetValueAsync<T>(key, defaultValue)`、`SetValueAsync<T>(key, value)`
- 位置：`Config` 目录（`serialport.config` / `portlock.config` / `devicename.config`）
- 行为：优先缓存，其次文件；缺失时使用 `appsettings.json` 默认值；写入失败记录日志。

### 配置模型
- `AppConfig`：`SelectedPort`、`IsPortLocked`、`DeviceName`、`ConnectionSettings`、`RetryPolicy`
- `ConnectionConfig`：串口参数 + 编码/超时，`NormalizeWithDefaults` 校正无效值
- `RetryPolicyConfig`：`ConnectRetries`、`SendRetries`、`BaseDelayMs`

### 协议/适配器扩展
- `ISerialPortAdapterFactory`：创建并配置适配器（默认 `DefaultSerialPortAdapterFactory`）
- `IProtocolParserFactory`：创建协议解析器（默认 `DefaultProtocolParserFactory`）
- `ISerialPortAdapter` 支持替换底层串口实现（测试/模拟）
- `IProtocolParser` 支持不同帧格式解析（当前为 `SimpleProtocolParser`）

### 工厂与策略
- 设备：`IDeviceControllerFactory` 负责创建控制器（默认返回 `PowerDeviceController` 单例）
- 协议：`IProtocolParserFactory` 便于按设备/协议替换解析器
- 适配器：`ISerialPortAdapterFactory` 便于注入模拟/自定义串口实现

---

## 数据流
```
用户操作 → MainForm → PowerDeviceController → SerialPortService → ISerialPortAdapter → 串口硬件
                                          ↑事件↑
                 SerialPortService.ConnectionStateChanged / DataReceived / DataSent → UI 更新 & 监视器
```

---

## UI 状态机
```
连接：Disconnected → (Connect) Connecting → Connected → (Disconnect) Disconnected
失败：Connecting → (Failure) Error → (Retry) Connecting
电源：Unknown → (ON) On → (OFF) Off → (Disconnect) Unknown
```
状态色：已连接=绿色，未连接=深灰，警告/连接中=橙色，错误=红色。

---

## 配置与重试策略
- 配置文件：`serialport.config`（串口）/`portlock.config`（锁定）/`devicename.config`（设备名）
- 默认值：`appsettings.json` → `IOptions<AppConfig>`
- 重试：Polly 指数退避；`IOptionsMonitor.OnChange` 热重建策略（1s 防抖，记录错误计数）
- 取消：`ConnectAsync`/`DisconnectAsync`/`SendCommandAsync` 支持 `CancellationToken`

---

## 依赖注入与生命周期
- 单例：`SerialPortService`、`PowerDeviceController`、`FileConfigRepository`、`MainForm`
- 瞬态：`SettingsForm`、`SerialMonitorForm`、`ISerialPortAdapter`（默认 `DefaultSerialPortAdapter`）
- HostBuilder 管理日志/配置绑定并负责释放单例；单例需线程安全。

---

## 测试与基准
- 单元测试：`Test Tool.Tests`、`WinFormsApp3.Tests`
- 基准测试：`BenchmarkSuite1` 针对 `SendCommandAsync`

---

**最后更新**：2025 年
