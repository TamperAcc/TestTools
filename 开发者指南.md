# 串口工具架构与开发指南（中文）

## 快速开始
- 打开解决方案并运行 `Test Tool` 项目，或命令行：`dotnet build` / `dotnet run --project "Test Tool"`
- 运行前可在 `appsettings.json` 配置默认串口、设备名及重试参数；运行后 `Config` 目录会生成用户配置文件

## 代码结构
- `Forms/`：`MainForm`（事件订阅、UI 联动）、`SettingsForm`（串口选择/锁定/监视器开关）、`SerialMonitorForm`（收发日志）
- `Business/Enums`：连接、电源状态等枚举
- `Business/Models`：`ConnectionConfig`、`AppConfig`、`RetryPolicyConfig`、`DeviceStatus`
- `Business/Services`：
  - `ISerialPortService`（连接/断开/发送、状态与数据事件，支持取消）
  - `ISerialPortAdapter` + `DefaultSerialPortAdapter`（底层串口抽象）
  - `IDeviceController` + `PowerDeviceController`（ON/OFF 封装，状态广播）
  - `IProtocolParser` + `SimpleProtocolParser`
- `Data/ConfigRepository`：文件型配置仓库，封装读取/保存/通用 `GetValueAsync` / `SetValueAsync`
- `Infrastructure/Constants`：应用默认值、命令、UI 颜色/文案、窗口拖动尺寸
- `Infrastructure/Helpers/UIHelper`：统一状态标签、按钮样式，字体缓存与释放
- `Test Tool.Tests` / `WinFormsApp3.Tests`：单元测试；`BenchmarkSuite1`：基准测试

## 服务生命周期（Program.cs）
- 单例：`SerialPortService`、`PowerDeviceController`、`FileConfigRepository`、`MainForm`
- 瞬态：`SettingsForm`、`SerialMonitorForm`、`ISerialPortAdapter`
- HostBuilder 提供日志与配置绑定（`IOptions<AppConfig>`），并负责释放单例资源

## 工作流
1. 启动时 `MainForm` 通过 `ConfigRepository.LoadAsync` 载入用户配置，初始化 `PowerDeviceController` 并订阅 `ISerialPortService` 事件
2. 连接：UI 组装 `ConnectionConfig`（合并 `appsettings.json` 默认值），调用 `ConnectAsync`；Polly 重试和 `CancellationToken` 均可用
3. 命令：`TurnOnAsync/TurnOffAsync` → `SendCommandAsync`，成功后广播 `StatusChanged` 更新按钮样式
4. 数据：`DataReceived`/`DataSent` 推送到 `SerialMonitorForm`，UI 线程通过 `Invoke/BeginInvoke` 安全更新
5. 设置：`SettingsForm` 负责串口列表、锁定、监视器开关；确认后保存到 `Config` 目录
6. 退出：取消事件订阅，`Dispose` 串口服务/控制器，释放字体资源

## 配置与重试
- 用户文件：`Config/serialport.config`、`portlock.config`、`devicename.config`
- 默认值：`appsettings.json` → `IOptions<AppConfig>`，包含串口默认参数与 `RetryPolicy`（ConnectRetries/SendRetries/BaseDelayMs）
- 热更新：`IOptionsMonitor.OnChange` 触发串口重试策略重建（防抖 1s，记录错误计数）
- API 取消：所有异步方法接受可选 `CancellationToken`

## 编码与测试建议
- 遵循 async/await；在 UI 层使用 `InvokeRequired` 保护跨线程访问
- 所有可释放对象实现/调用 `Dispose`（串口适配器、字体、选项变更令牌）
- 通过替换 `ISerialPortAdapter`、`IProtocolParser` 可实现模拟/不同协议，便于单元测试
- 测试入口：`Test Tool.Tests` 与 `WinFormsApp3.Tests`；基准入口：`BenchmarkSuite1`

## 扩展点
- 协议：实现 `IProtocolParser` 或 `IProtocolParserFactory` 以支持新帧格式
- 硬件：实现 `ISerialPortAdapter` 或 `ISerialPortAdapterFactory` 以适配虚拟串口/模拟串口
- 设备：实现 `IDeviceController` 或 `IDeviceControllerFactory` 以支持不同命令集
- 配置：实现自定义 `IConfigRepository`（数据库/云端）

**最后更新**：2025 年
