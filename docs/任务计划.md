# 📋 项目任务计划追踪

> 此文档用于持久化记录所有任务计划，任务要求，便于规范、追溯和管理。

---
##编程要求
计划文件（临时）一定要用中文编写，任务名称、描述、分析、要求、步骤、清单、执行记录等均使用中文，保持一致性和可读性。
-分析任务，拆分任务目标。
-列出关键点。
-分析扩展性维护性可读性。
-修改代码直接修改文件,不要通过终端传输代码。
-程序、模块添加中文注释保持一致性。
-验证构建成功。
-更新任务计划。
-更新项目架构。

---

## 📌 任务索引

| 任务编号 | 任务名称 | 状态 | 创建日期 | 完成日期 |
|---------|---------|------|---------|---------|
| TASK-001 | 串口设置窗口添加一键开启/关闭打印窗口及位置保存功能 | ✅ 已完成 | 2024-12-28 | 2024-12-28 |
| TASK-002 | 窗口位置保存和串口设置窗口按钮修复 | ✅ 已完成 | 2024-12-28 | 2024-12-28 |
| TASK-003 | 项目模块化重构与代码优化 | ✅ 已完成 | 2024-12-28 | 2024-12-28 |
| TASK-004 | 项目结构中文标注完善 | ✅ 已完成 | 2025-12-31 | 2025-12-31 |
| TASK-005 | 串口适配器健壮性与设置窗体接口补全 | ☑ 进行中 | 2026-01-01 | - |
| TASK-006 | 全局优化分阶段计划 | ☑ 进行中 | 2026-01-02 | - |
| TASK-007 | 命名空间统一与模型初始化优化 | ☑ 进行中 | 2026-01-05 | - |
| TASK-008 | 串口服务与适配器健壮性加强 | ☑ 进行中 | 2026-01-05 | - |
| TASK-009 | UI 表单校验与事件解绑完善 | ☑ 进行中 | 2026-01-05 | - |
| TASK-010 | 测试覆盖与基准检查 | ☑ 进行中 | 2026-01-05 | - |
| TASK-011 | 模块清单与代码巡检 | □ 待开始 | 2026-01-07 | - |

---

## 现有项目结构
```
Test Tool/
├── TestTool.Core/                 # 核心层（模型、枚举、接口）
│   ├── Enums/DeviceEnums.cs       # 设备类型/状态枚举
│   ├── Events/DeviceEventArgs.cs  # 设备事件参数基类
│   ├── Models/DeviceModels.cs     # 设备/连接配置与状态模型
│   ├── Models/ProtocolModels.cs   # 协议解析帧模型
│   └── Services/*.cs              # 核心接口
├── TestTool.Business/             # 业务层（实现）
│   └── Services/
│       ├── DefaultSerialPortAdapter.cs # 串口适配器实现
│       ├── Factories.cs                # 工厂实现
│       ├── MainFormCoordinator.cs      # 单设备协调器
│       ├── MultiDeviceCoordinator.cs   # 多设备协调器
│       ├── PowerDeviceController.cs    # 电源控制器
│       ├── SerialPortService.cs        # 串口服务
│       └── SimpleProtocolParser.cs     # 简单协议解析器
├── TestTool.Infrastructure/       # 基础设施层
│   ├── Constants/
│   │   ├── AppConstants.cs        # 应用常量
│   │   ├── UIConstants.cs         # UI 颜色/文案常量
│   │   └── UIFormConstants.cs     # 窗体尺寸常量
│   └── Helpers/UIHelper.cs        # UI 辅助方法
├── Data/ConfigRepository.cs       # 配置仓库（JSON 持久化，链接到业务层）
├── Forms/                         # UI 层（WinForms）
│   ├── Base/ResizableFormBase.cs  # 可调整大小基类
│   ├── MainForm*.cs               # 主窗体
│   ├── MultiDeviceSettingsForm*.cs# 多设备设置窗体
│   ├── SerialMonitorForm*.cs      # 串口监视窗体
│   └── SettingsForm*.cs           # 旧版设置窗体
├── TestTool.UI/                   # UI 独立项目（WinForms shell）
├── TestTool.Tests/                # 单元测试项目
│   ├── SerialPortServiceTests.cs  # 串口服务测试
│   ├── MultiDeviceSettingsPresenterTests.cs # Presenter 测试
│   └── FileConfigRepositoryTests.cs # 配置仓库测试
├── BenchmarkSuite1/               # 基准测试（本地/开发观测）
│   └── SerialPortServiceSendCommandBenchmark.cs
└── Program.cs                     # 程序入口（DI 配置）
```

---

## 📝 任务模板

```markdown
## TASK-XXX: [任务名称]

**状态**: □ 待开始 | ☑ 进行中 | ✅ 已完成 | ✖ 已取消  
**创建日期**: YYYY-MM-DD  
**完成日期**: -

### 任务描述
[描述任务目标和背景]

### 任务分析


### 任务要求


### 步骤清单
- [ ] 步骤1
- [ ] 步骤2
- [ ] 步骤3
...

### 执行记录
[记录执行过程中的重要信息]

### 相关文件
- file1.cs
- file2.cs
```

---

## TASK-001: 串口设置窗口添加一键开启/关闭打印窗口及位置保存功能

**状态**: ✅ 已完成  
**创建日期**: 2024-12-28  
**完成日期**: 2024-12-28

### 完成步骤
- [x] 修改 DeviceConfig 模型添加打印窗口位置属性
- [x] 修改 DeviceConfigJson 添加窗口位置序列化字段
- [x] 修改 ConfigRepository 读写窗口位置配置
- [x] 修改 SerialMonitorForm 添加位置保存/恢复逻辑
- [x] 修改 MainForm 在打开/关闭打印窗口时保存位置
- [x] 修改 MultiDeviceSettingsForm 添加一键开启/关闭打印按钮
- [x] 验证构建成功
- [x] 生成 exe

---

## TASK-002: 窗口位置保存和串口设置窗口按钮修复

**状态**: ✅ 已完成  
**创建日期**: 2024-12-28  
**完成日期**: 2024-12-28

### 完成步骤
- [x] 修改 DeviceModels 添加主窗口和设置窗口位置属性
- [x] 修改 ConfigRepository 读写主窗口和设置窗口位置
- [x] 修改 MainForm 添加关闭时保存位置逻辑
- [x] 修改 MultiDeviceSettingsForm 添加最小化/最大化按钮和位置保存
- [x] 验证构建成功

---

## TASK-003: 项目模块化重构与代码优化

**状态**: ✅ 已完成  
**创建日期**: 2024-12-28  
**完成日期**: 2024-12-28

### 任务背景
基于项目架构分析报告，进行全面的模块化重构和代码优化。

### 优化项清单

#### 阶段一：基础优化（优先级：高）- ✅ 已完成
| 序号 | 优化项 | 状态 | 说明 |
|------|--------|------|------|
| 3.1 | 修复 UIConstants.cs 中文乱码 | ✅ 已完成 | 文件编码问题已修复 |
| 3.2 | 修复 UIHelper.cs 中文乱码 | ✅ 已完成 | 文件编码问题已修复 |
| 3.3 | 修复 IDeviceServices.cs 中文乱码 | ✅ 已完成 | 文件编码问题已修复 |
| 3.4 | 修复 AppConstants.cs 格式问题 | ✅ 已完成 | 代码格式已统一 |
| 3.5 | 添加一键连接/断开功能 | ✅ 已完成 | MainForm 新增功能 |
| 3.6 | 添加一键开启/关闭打印功能 | ✅ 已完成 | MultiDeviceSettingsForm 新增功能 |

#### 阶段二：项目拆分（优先级：中）- 🔄 进行中
| 序号 | 优化项 | 状态 | 说明 |
|------|--------|------|------|
| 3.7 | 创建 TestTool.Core 项目 | ✅ 已完成 | 核心接口和模型迁移到项目目录 |
| 3.8 | 创建 TestTool.Business 项目 | ✅ 已完成 | 业务实现迁移到项目目录 |
| 3.9 | 创建 TestTool.Infrastructure 项目 | ✅ 已完成 | 基础设施代码迁移到项目目录 |
| 3.10 | 创建 TestTool.UI 项目 | ✅ 已完成 | UI 层独立项目创建并编译通过 |
| 3.11 | 迁移现有代码到新项目结构 | ✅ 已完成 | 清理重复源码并仅通过项目引用 |

#### 阶段三：架构优化（优先级：低）- ✅ 已完成
| 序号 | 优化项 | 状态 | 说明 |
|------|--------|------|------|
| 3.12 | 提取重复的 WndProc 代码到基类 | ✅ 已完成 | 三个窗体已继承 ResizableFormBase |
| 3.13 | 合并相似的 EventArgs 类型 | ✅ 已完成 | 创建 DeviceEventArgs<T> 泛型基类 |
| 3.14 | 引入 MVVM/MVP 模式 | ☑ 进行中 | 进一步解耦 UI |
| 3.15 | 添加单元测试项目 | ✅ 已完成 | 提高可测试性 |

### 执行记录

#### 2024-12-28 - 阶段一完成
- [x] 步骤 3.1: 修复 UIConstants.cs 中文乱码
- [x] 步骤 3.2: 修复 UIHelper.cs 中文乱码
- [x] 步骤 3.3: 修复 IDeviceServices.cs 中文乱码
- [x] 步骤 3.4: 修复 AppConstants.cs 格式问题
- [x] 步骤 3.5: 添加一键连接/断开功能
- [x] 步骤 3.6: 添加一键开启/关闭打印功能
- [x] 验证构建成功

#### 2024-12-28 - 阶段三架构优化
- [x] 步骤 3.12: 重构 SerialMonitorForm 继承 ResizableFormBase
- [x] 步骤 3.12: 重构 MultiDeviceSettingsForm 继承 ResizableFormBase  
- [x] 步骤 3.12: 重构 MainForm 继承 ResizableFormBase
- [x] 步骤 3.13: 创建 DeviceEventArgs<T> 泛型基类
- [x] 步骤 3.13: 重构4个EventArgs类继承泛型基类
- [x] 步骤 3.15: 添加单元测试项目并修复构建
- [x] 验证构建成功

#### 2025-12-31 - 阶段二拆分进展
- [x] 步骤 3.7: 创建 TestTool.Core 项目
- [x] 步骤 3.8: 创建 TestTool.Business 项目
- [x] 步骤 3.9: 创建 TestTool.Infrastructure 项目
- [x] 步骤 3.10: 创建 TestTool.UI 项目（独立 WinForms，已通过全量构建）
- [x] 步骤 3.11: 迁移现有代码到新项目结构并清理重复源码
- [x] 全量构建验证通过

#### 2025-12-31 - 阶段三 MVP 初步落地
- [x] MultiDeviceSettingsForm 接入 MVP（新增 Presenter 绑定，主窗体暴露接口）

---

## TASK-004: 项目结构中文标注完善

**状态**: ✅ 已完成  
**创建日期**: 2025-12-31  
**完成日期**: 2025-12-31

### 任务描述
为项目结构文档补充各子文件中文标注，保持与目录注释一致，便于快速定位职责。

### 完成步骤
- [x] 调整项目结构树，补充 Core/Business/Infrastructure 子文件中文说明
- [x] 标注 UI 层各窗体用途
- [x] 保留现有目录级说明，补充文件级说明

---

## TASK-005: 串口适配器健壮性与设置窗体接口补全

**状态**: ☑ 进行中  
**创建日期**: 2026-01-01  
**完成日期**: -

### 任务描述
提升串口适配器的健壮性（超时、幂等释放、状态校验）并补全设置窗体的 MVP 接口构造重载，以保证调用一致和可扩展性。

### 任务分析
- 串口适配器：默认超时、编码、状态检测与幂等 Dispose，避免未打开/已释放读写。
- 设置窗体：补充带 Presenter 构造重载，实现 IMultiDeviceSettingsView 接口方法，支持 Monitor 状态更新与可用端口刷新。
- 验证：全量构建，通过单元测试（如有）。

### 任务要求
- Task 使用中文
- 修改代码直接修改文件,不要通过终端传输代码
- 更新任务计划
- 验证构建成功
- 使用中文注释相关模块 保持一致性

### 步骤清单
- [x] 串口适配器增加默认超时、编码和状态校验
- [x] 串口适配器 Dispose 幺端处理
- [x] 设置窗体补充带 Presenter 构造重载
- [x] 设置窗体实现刷新端口/监视器状态接口
- [x] 构建验证

### 执行记录
- 2026-01-01 完成串口适配器健壮性提升；添加带 Presenter 构造与视图接口实现。
- 2026-01-01 构建验证通过。

### 相关文件
- TestTool.Business/Services/DefaultSerialPortAdapter.cs
- Forms/MultiDeviceSettingsForm.Extensions.cs

---

## TASK-006: 全局优化分阶段计划

**状态**: ☑ 进行中  
**创建日期**: 2026-01-02  
**完成日期**: -

### 任务描述
根据历史任务优化数据，分析并制定全局优化的分阶段计划，明确优化方向、范围、优先级和阶段成果，便于监控和评估。

### 任务分析
- 阶段划分：根据任务依赖关系和优化难度，将优化分为若干阶段。
- 每个阶段目标：确保每个阶段有明确可交付的成果，并能有效评估优化效果。
- 优先级评估：根据业务价值和技术风险评估各阶段优先级。

### 任务要求
- Task 使用中文
- 修改代码直接修改文件,不要通过终端传输代码
- 更新任务计划
- 验证构建成功
- 使用中文注释相关模块 保持一致性

### 步骤清单
- [ ] 分析历史任务数据
- [ ] 确定优化阶段和目标
- [ ] 编写优化计划文档
- [ ] 评审和确认优化计划
- [ ] 按计划执行优化

### 执行记录
- 2026-01-02 依据历史任务数据，初步分析并规划全局优化的阶段性目标和优先级。待进一步细化和确认。

### 相关文件
- None

---

## TASK-007: 命名空间统一与模型初始化优化

**状态**: ☑ 进行中  
**创建日期**: 2026-01-05  
**完成日期**: -

### 任务描述
统一 Core 層命名空間至 TestTool.Core，減少跨層耦合；優化 AppConfig 默認設備初始化與無副作用規範。

### 任务分析
- 命名空间一致性：Enums/Models/Services 使用 Core 命名空间，消除 Business 前缀残留。
- 模型初始化：默认设备惰性创建，避免 NormalizeWithDefaults 直接修改源实例。
- 兼容性：保留旧属性的兼容访问并标注 Obsolete。

### 任务要求
- Task 使用中文
- 修改代码直接修改文件,不要通过终端传输代码
- 更新任务计划
- 验证构建成功
- 使用中文注释相关模块 保持一致性

### 步骤清单
- [x] 统一 Core 命名空间
- [x] 优化 AppConfig 默认设备初始化
- [x] NormalizeWithDefaults 改为无副作用返回
- [x] 构建验证

### 执行记录
- 2026-01-05 更新 UI/测试/基准项目命名空间引用至 TestTool.Core，修复构建通过；SettingsForm 占位修复保持兼容。
- 2026-01-05 ConnectionConfig NormalizeWithDefaults 改为返回新实例无副作用；AppConfig 默认设备惰性创建，统一命名空间引用。
- 2026-01-06 全量构建验证通过（含命名空间/模型调整）。

### 相关文件
- TestTool.Core/Enums/DeviceEnums.cs
- TestTool.Core/Models/DeviceModels.cs
- TestTool.Core/Services/*.cs

---

## TASK-008: 串口服务与适配器健壮性加强

**状态**: ☑ 进行中  
**创建日期**: 2026-01-05  
**完成日期**: -

### 任务描述
增强 SerialPortService 与 DefaultSerialPortAdapter 的错误处理、重试策略、资源释放和日志节流，确保串口操作可恢复且可测试。

### 现状总结
- SerialPortService 已使用 Polly 重试、热更新配置，并通过 Channel 缓冲接收数据，但重试日志节流与取消/回滚保护仍需加强。
- DefaultSerialPortAdapter 封装 System.IO.Ports.SerialPort，提供默认超时与编码，Open/Close/Dispose 幂等性可进一步校验。
- MultiDeviceCoordinator 为每个设备维护独立 ISerialPortService/IDeviceController，并转发 Connection/Data/Status 事件。
- 测试覆盖连接/发送重试与事件异常隔离，BenchmarkSuite1 提供 SerialPortService 发送性能基准。

### 任务分析
- 重试策略：优化热更新与执行时的防抖、日志节流与错误计数，确保支持取消并在失败时回滚状态。
- 适配器：保证 Open/Close/Dispose 幂等，DataReceived 订阅对称，编码/超时参数校验与默认值兜底。
- Channel/状态：连接或异常时完成 Channel、解除事件、回滚 CurrentConfig/State，避免悬挂或重复写入。
- 日志与可观测：发送/接收/状态变更日志分级与采样，提供错误计数或告警钩子便于排查。

### 任务要求
- Task 使用中文
- 修改代码直接修改文件,不要通过终端传输代码
- 更新任务计划
- 验证构建成功
- 使用中文注释相关模块 保持一致性

### 步骤清单
- [x] 重试策略与日志节流增强
- [x] 适配器幂等与事件解绑
- [x] Channel 完成与状态回滚
- [x] 构建验证

### 执行记录
- 2026-01-05 完成串口重试日志节流、重试前适配器清理、连接失败状态回滚；全量构建通过。

### 相关文件
- TestTool.Business/Services/SerialPortService.cs
- TestTool.Business/Services/DefaultSerialPortAdapter.cs
- TestTool.Business/Services/Factories.cs

---

## TASK-009: UI 表单校验与事件解绑完善

**状态**: ☑ 进行中  
**创建日期**: 2026-01-05  
**完成日期**: -

### 任务描述
完善 WinForms 窗体的校验、端口冲突提示、事件订阅解绑与跨线程更新，提升可用性和稳定性。

### 任务分析
- 校验：波特率使用 DropDownList 或严格验证，端口冲突提示。
- 事件：MonitorStateChanged、SettingsLocked 等订阅在 Dispose 对称解绑。
- UI 线程：统一使用 UIHelper.SafeInvoke，WndProc 复用基类。

### 任务要求
- Task 使用中文
- 修改代码直接修改文件,不要通过终端传输代码
- 更新任务计划
- 验证构建成功
- 使用中文注释相关模块 保持一致性

### 步骤清单
- [x] 表单校验与端口冲突提示
- [x] 事件订阅解绑与线程安全
- [x] 基类/常量复用检查
- [x] 构建验证

### 执行记录
- 2026-01-06 MultiDeviceSettingsForm：锁定前校验空串口/冲突/波特率，MonitorStateChanged 订阅持有句柄并在 Dispose 对称解绑；继承 ResizableFormBase 复用拖拽缩放，构建通过。

### 相关文件
- TestTool.UI/Forms/MultiDeviceSettingsForm*.cs
- TestTool.Infrastructure/Helpers/UIHelper.cs

---

## TASK-010: 测试覆盖与基准检查

**状态**: ☑ 进行中  
**创建日期**: 2026-01-05  
**完成日期**: -

### 任务描述
扩充单元测试覆盖串口服务重试/异常路径、Presenter 交互、配置持久化；评估 BenchmarkSuite1 使用价值。

### 任务分析
- 串口服务：重试、防抖、Channel 完成、异常回滚测试。
- UI Presenter：Mock 协调器验证事件映射。
- 配置仓库：序列化/反序列化位置与重试配置一致性。
- 基准：保留或标记为仅开发使用。

### 任务要求
- Task 使用中文
- 修改代码直接修改文件,不要通过终端传输代码
- 更新任务计划
- 验证构建成功
- 使用中文注释相关模块 保持一致性

### 步骤清单
- [x] 串口服务异常/重试测试
- [x] Presenter/配置仓库测试
- [x] BenchmarkSuite1 评估与标注
- [x] 构建/测试验证

### 执行记录
- 2026-01-06 增补串口服务测试：连接失败回滚到 Disconnected，未连接发送返回 false 并置为 Error；run_build 通过。
- 2026-01-06 增补 MultiDeviceSettingsPresenter 测试（解锁断开保存、确认保存全设备）；BenchmarkSuite1 标注为开发用途，run_build 通过。

---

## TASK-011: 模块清单与代码巡检

**状态**: □ 待开始  
**创建日期**: 2026-01-07  
**完成日期**: -

### 任务描述
列出所有项目/模块并安排逐一代码级别检查，覆盖 UI、业务、核心、基础设施、测试与基准模块。

### 任务分析
- 梳理项目列表，明确职责范围。
- 逐模块检查：接口一致性、异常处理、资源释放、线程安全、UI 布局/锚点、日志与配置。
- 输出问题清单与优化建议，按优先级排期。

### 任务要求
- Task 使用中文。
- 修改代码直接修改文件，不要通过终端传输代码。
- 更新任务计划。
- 验证构建成功（如涉及代码更改）。
- 相关模块添加中文注释保持一致性。

### 模块清单（待巡检）
- TestTool.Core：Enums、Events、Models、Services 接口。
- TestTool.Business：SerialPortService、DefaultSerialPortAdapter、MultiDeviceCoordinator、PowerDeviceController、Factories、SimpleProtocolParser、MainFormCoordinator。
- TestTool.Infrastructure：Constants（App/UI/UIForm）、Helpers（UIHelper）。
- TestTool.UI：WinForms 主程序（MainForm、MultiDeviceSettingsForm、SerialMonitorForm、SettingsForm、基类 ResizableFormBase、MVP 相关）。
- TestTool.Tests：单元测试（串口服务、Presenter、配置仓库等）。
- Data：ConfigRepository（JSON 持久化）。
- BenchmarkSuite1：SerialPortServiceSendCommandBenchmark。

### 步骤清单
- [ ] 模块职责确认与风险初评
- [ ] 核心/业务模块代码巡检（接口/异常/释放）
- [ ] UI 模块巡检（布局/锚点/线程安全）
- [ ] 配置与数据持久化巡检
- [ ] 测试与基准巡检
- [ ] 汇总问题与优化建议

### 执行记录
- 待开始

### 相关文件
- 全项目源代码（见模块清单）
